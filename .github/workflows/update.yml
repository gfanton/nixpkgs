name: Update flake inputs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 3,6'  # Wednesday and Saturday at 03:00 UTC

env:
  CACHIX_USER: gfanton

jobs:
  update-flake-lock:
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.update.outputs.pull-request-number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Update flake.lock
        id: update
        uses: DeterminateSystems/update-flake-lock@v24
        with:
          token: ${{ secrets.BOT_PAT }}
          pr-title: "nix: update flake inputs"
          pr-labels: |
            dependencies
            automated
          commit-msg: "nix: update flake.lock"

  # Add nvd diff as PR comment after PR is created
  add-diff-comment:
    needs: update-flake-lock
    if: needs.update-flake-lock.outputs.pr-number
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: master
          path: base

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: update_flake_lock_action
          path: updated

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: ${{ env.CACHIX_USER }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build and generate diff
        id: diff
        run: |
          cd base
          nix build ".#homeConfigurations.githubCI.activationPackage" -o /tmp/base-result
          cd ../updated
          nix build ".#homeConfigurations.githubCI.activationPackage" -o /tmp/updated-result

          # Generate nvd diff
          DIFF=$(nix-shell -p nvd --run "nvd diff /tmp/base-result /tmp/updated-result" | tail -n +3 || echo "No changes detected")

          # Save to file for multiline output
          echo "$DIFF" > /tmp/nvd-diff.txt
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/nvd-diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.BOT_PAT }}
          issue-number: ${{ needs.update-flake-lock.outputs.pr-number }}
          body: |
            ## Package Changes (nvd diff)
            ```
            ${{ steps.diff.outputs.diff }}
            ```

            ---
            *Generated automatically by CI*
